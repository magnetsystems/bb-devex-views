baselineUbuntu() {
    # update OS
    sudo apt-get -y update 1>/dev/null && sudo apt-get -y upgrade 1>/dev/null

    #install nodejs
    sudo apt-get -y install nodejs 1>/dev/null

    # install zip and unzip
    sudo apt-get -y install unzip 1>/dev/null

    echo
    echo 'Linux prepared'
    echo
}

installJre() {
    if type -p java >/dev/null; then
        _java=java
    elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]];  then
        _java="$JAVA_HOME/bin/java"
    else
        echo "No java detected."
        sudo apt-get -y install openjdk-6-jre 1>/dev/null
        echo
        echo 'openjdk-6-jre Installed'
        echo
    fi

    if [[ "$_java" ]]; then
        version=$("$_java" -version 2>&1 | awk -F '"' '/version/ {print $2}')
        if [[ "$version" < "1.6" ]]; then
            echo "version is less than 1.6"
            sudo apt-get -y install openjdk-6-jre 1>/dev/null
            echo
            echo 'openjdk-6-jre Installed'
            echo
        fi
    fi
}

install_MySQL () {
    if type -p mysql >/dev/null; then
        echo
        echo '!!! MySQL present !!!'
        echo
    else
        sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password password test'
        sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password test'
        sudo apt-get -y install mysql-server 1>/dev/null

        echo
        echo 'MySQL installed'
        echo

        echo
        echo "Default database magnetmessaging prepared"
        echo
    fi
}

case "`uname`" in
    CYGWIN*)
        echo
        echo '!!! Please note that Magnet Messaging does not support cygwin. Please visit factory.magnet.com and download the zip file !!!'
        echo
        exit 1
        ;;
    Darwin*)
        echo
        echo '!!! Please note that this installation does not support Mac. Please download the Mac installer from factory.magnet.com !!!'
        echo
        exit 1
        ;;
    Linux*)
        if ! which apt-get >/dev/null; then
            echo
            echo '!!! This installation supports Ubuntu and Debian Linux only. For other flavors, please visit factory.magnet.com !!!'
            echo
            exit 1
        fi
        ;;
esac

DIR="mmx-standalone-dist"
PACKAGE="$DIR.zip"
TIME=`date +%F-%H%M%S`

echo
echo 'Installing Magnet Messaging and its dependency (if not already available: openjdk-6-jre, mysql, and node.js), and upgrading Linux. It may take minutes depending on the network speed. When installing the dependency, it may prompt you for the root password.'
echo 'For EC2 instances, you may see "sudo: unable to resolve host...", which is ignorable.'
echo

if [ -f $PACKAGE ]; then
    mv $PACKAGE $PACKAGE.$TIME
    echo
    echo 'Backed up old zip file.'
    echo
fi

if [ -d $DIR ]; then
    pushd $DIR 1>/dev/null
    ./mmx.sh stop
    popd 1>/dev/null
    mv $DIR $DIR.$TIME
    echo
    echo 'Backed up old Magnet Messaging home.'
    echo
else
    baselineUbuntu
    installJre
    install_MySQL
fi

curl -sS --header "Authorization: {{-authHeader}}" -o $PACKAGE "{{-appUrl}}/resources/files/mmx-standalone-dist.zip"
unzip ./$PACKAGE 1>/dev/null

echo
echo 'Magnet Messaging installed'
echo "Magnet Messaging home: $PWD/$DIR"
echo "To operate the server, please use $PWD/mmx.sh"
echo 'To uninstall, please stop the server and then remove the Magnet Messaging home directory.'
echo
cd mmx-standalone-dist
./mmx.sh start
if [ $? -eq 0 ]; then
    echo
    echo "Please continue with the setup by configuring the Magnet Messaging Admin Console at http://<ip_address_or_localhost>:3000/wizard"
    echo
else
    echo
    echo "!!! Error occured when starting the server. Please correct it according to what is shown above and try again !!!"
    echo
fi
    echo
